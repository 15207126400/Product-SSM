<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yunwei.product.common.dao.YwOrderDao">

	<resultMap type="YwOrder" id="resultMap">
       <id column="order_id" property="order_id" />
       <result column="order_type" property="order_type" />
       <result column="order_flag" property="order_flag" />
       <result column="openid" property="openid" />
       <result column="share_openid" property="share_openid" />
       <result column="order_sn" property="order_sn" />
       <result column="order_createtime" property="order_createtime" />
       <result column="order_updatetime" property="order_updatetime" />
       <result column="order_paytime" property="order_paytime" />
       <result column="order_sendtime" property="order_sendtime" /> 
       <result column="order_successtime" property="order_successtime" />
       <result column="order_status" property="order_status" /> 
       <result column="couponid" property="couponid" /> 
       <result column="order_name" property="order_name" /> 
       <result column="order_tel" property="order_tel" />
       <result column="order_address" property="order_address" />
       <result column="order_totalprice" property="order_totalprice" />
       <result column="order_remark" property="order_remark" />
       <result column="transport_sn" property="transport_sn" />
       <result column="order_points" property="order_points" />
       <result column="order_import_status" property="order_import_status" />
       <result column="order_delivery_method" property="order_delivery_method" />
       <result column="branch_id" property="branch_id" />
       <result column="order_delivery_fee" property="order_delivery_fee" />
       <result column="branch_name" property="branch_name" />
       <result column="branch_logo" property="branch_logo" />
       <association property="ywOrderPayment" javaType="com.yunwei.product.common.model.YwOrderPayment" notNullColumn="order_sn" column="order_sn" fetchType="lazy">
          <id column="order_pay_id" property="order_pay_id" />
          <result column="order_pay_code" property="order_pay_code" />
          <result column="order_pay_remark" property="order_pay_remark" />
       </association>
       <association property="teamFoundData" column="order_sn" notNullColumn="order_sn" javaType="com.yunwei.product.common.model.YwTeamFound" fetchType="lazy">
          <id column="found_id" property="found_id" />
          <result column="head_pic" property="head_pic" />
          <result column="found_join" property="found_join" />
          <result column="need" property="need" />
       </association>
       <association property="teamFollowData" column="order_sn" notNullColumn="order_sn" javaType="com.yunwei.product.common.model.YwTeamFollow" fetchType="lazy">
          <id column="follow_id" property="follow_id" />
          <result column="found_id" property="found_id" />
          <!-- <association property="teamFoundData" javaType="com.yunwei.product.common.model.YwTeamFound" column="found_id" notNullColumn="found_id">
              <id column="found_id" property="found_id" />
	          <result column="found_join" property="found_join" />
	          <result column="need" property="need" />
          </association> -->
       </association>
       <collection property="ywOrderItems" ofType="com.yunwei.product.common.model.YwOrderItem" column="order_sn" notNullColumn="order_sn" fetchType="lazy">
           <result column="order_sn_i" property="order_sn" />
	       <result column="product_id" property="product_id" />
	       <result column="order_ite_count" property="order_ite_count" />
	       <result column="order_ite_price" property="order_ite_price" />
	       <result column="order_ite_img" property="order_ite_img" />
	       <result column="order_ite_name" property="order_ite_name" />
	       <result column="order_ite_sku" property="order_ite_sku" />
       </collection>
       
      </resultMap>

    <sql id="sql">
       order_id,order_type,order_flag,openid,share_openid,order_sn,order_createtime,order_updatetime,order_paytime,order_sendtime,order_successtime,order_status,couponid,order_name,order_tel,order_address,order_totalprice,order_remark,transport_sn,order_points,order_import_status,order_delivery_method,branch_id,order_delivery_fee
    </sql>
    <sql id="insertSql">
       order_type,order_flag,openid,share_openid,order_sn,order_createtime,order_updatetime,order_paytime,order_sendtime,order_successtime,order_status,couponid,order_name,order_tel,order_address,order_totalprice,order_remark,transport_sn,order_points,order_import_status,order_delivery_method,branch_id,order_delivery_fee
    </sql>
    
    <sql id = "whereSql">
	     <where>
	        <if test="order_id != null and order_id != '' ">
	          <!-- like CONCAT(CONCAT('%',#{id}),'%') -->
	          and order_id = #{order_id}
	        </if>
	        <if test="order_sn != null and order_sn != '' ">
	          and order_sn = #{order_sn}
	        </if>
	        <if test="openid != null and openid != '' ">
	          and openid = #{openid}
	        </if>
	        <if test="order_status != null and order_status != '' ">
	          and order_status = #{order_status} 
	        </if>
	        <if test="order_type != null and order_type != '' ">
	          and order_type = #{order_type}
	        </if>
	        <if test="order_updatetime != null and order_updatetime != '' ">
	          and order_updatetime &lt;= #{order_updatetime}
	        </if>
	        <if test="branch_id != null and branch_id != '' ">
	          and branch_id = #{branch_id}
	        </if>
	        and order_status != '9'
	    </where> 
    </sql>
    
    <sql id = "wherePageSql">
	     <where>
	        <if test="order_id != null and order_id != '' ">
	          <!-- like CONCAT(CONCAT('%',#{id}),'%') -->
	          and order_id = #{order_id}
	        </if>
	        <if test="order_sn != null and order_sn != '' ">
	          and order_sn = #{order_sn}
	        </if>
	        <if test="openid != null and openid != '' ">
	          and openid = #{openid}
	        </if>
	        <if test="order_status != null and order_status != '' ">
	          and order_status = #{order_status} 
	        </if>
	        <if test="order_type != null and order_type != '' ">
	          and order_type = #{order_type}
	        </if>
	        <if test="order_updatetime != null and order_updatetime != '' ">
	          and order_updatetime &lt;= #{order_updatetime}
	        </if>
	        <if test="begin_datetime != null and begin_datetime != '' ">
	          and date_format(order_createtime,'%Y-%m-%d') &gt;= #{begin_datetime}
	        </if>
	        <if test="end_datetime != null and end_datetime != '' ">
	          and date_format(order_createtime,'%Y-%m-%d') &lt;= #{end_datetime}
	        </if>
	        <if test="branch_id != null and branch_id != '' ">
	          and branch_id = #{branch_id}
	        </if>
	        and order_status != '9'
	    </where> 
    </sql>
    
    <sql id="whereMapSql">
      <where>
        <if test="order_sn != null and order_sn != '' ">
          and o.order_sn = #{order_sn}
        </if>
        <if test="order_remark != null and order_remark != '' ">
          and o.order_remark like CONCAT(CONCAT('%',#{order_remark}),'%')
        </if>
        <if test="nickname != null and nickname != '' ">
          and o.nickname like CONCAT(CONCAT('%',#{nickname}),'%')
        </if>
        <if test="begin_datetime != null and begin_datetime != '' ">
          and date_format(o.order_createtime,'%Y-%m-%d') &gt;= #{begin_datetime}
        </if>
        <if test="end_datetime != null and end_datetime != '' ">
          and date_format(o.order_createtime,'%Y-%m-%d') &lt;= #{end_datetime}
        </if>
        <if test="order_status != null and order_status != '' ">
          and o.order_status = #{order_status}
        </if>
        <if test="branch_id != null and branch_id != '' ">
          and o.branch_id = #{branch_id}
        </if>
        and order_status != '9'
       </where>  
    </sql>
    
    <sql id = "whereUnionSql">
	     <where>
	        <if test="order_sn != null and order_sn != '' ">
	          and o.order_sn = #{order_sn}
	        </if>
	        <if test="openid != null and openid != '' ">
	          and o.openid = #{openid}
	        </if>
	        <if test="order_status != null and order_status != '' ">
	          and o.order_status = #{order_status} 
	        </if>
	        <if test="order_type != null and order_type != '' ">
	          and o.order_type = #{order_type}
	        </if>
	        <if test="order_updatetime != null and order_updatetime != '' ">
	          and o.order_updatetime &lt;= #{order_updatetime}
	        </if>
	        <if test="branch_id != null and branch_id != '' ">
	          and o.branch_id = #{branch_id}
	        </if>
	        and o.order_status != '9'
	    </where> 
    </sql>
    
    <sql id="whereBatchSql">
		<where>
			<if test="order_sn != null and order_sn != '' ">
				and order_sn in
				<foreach collection="order_sn" item="id" separator="," open="("
					close=")">
					#{id}
				</foreach>
			</if>
		</where>
	</sql>
    

	<!-- 字典保存 -->
	<insert id="insert" parameterType="com.yunwei.product.common.model.YwOrder">
		insert into yw_order(<include refid="insertSql"/>) values(#{order_type},#{order_flag},#{openid},#{share_openid},#{order_sn},#{order_createtime},#{order_updatetime},#{order_paytime},#{order_sendtime},#{order_successtime},#{order_status},#{couponid},#{order_name},#{order_tel},#{order_address},#{order_totalprice},#{order_remark},#{transport_sn},#{order_points},#{order_import_status},#{order_delivery_method},#{branch_id},#{order_delivery_fee})
	</insert>
	
	<!-- 查询所有字典信息-->
	<select id="queryList" parameterType="java.util.Map" resultType="com.yunwei.product.common.model.YwOrder">
		select <include refid="sql"/> from yw_order
		<include refid="whereSql"/>
	</select>
	
	
	
	<!-- 查询表该表与其他表关联信息-->
	<select id="queryUnionList" parameterType="java.util.Map" resultMap="resultMap">
		select
		o.order_id,
		o.order_type,
		o.order_flag,
		o.openid,
		o.share_openid,
		o.order_sn,
		o.order_createtime,
		o.order_updatetime,
		o.order_paytime,
		o.order_sendtime,
		o.order_successtime,
		o.order_status,
		o.couponid,
		o.order_name,
		o.order_tel,
		o.order_address,
		o.order_totalprice,
		o.order_remark,
		o.transport_sn,
		o.order_points,
		o.order_import_status,
		o.order_delivery_method,
		o.branch_id,
		o.order_delivery_fee,
		i.order_sn as order_sn_i,
		i.product_id,
		i.order_ite_count,
		i.order_ite_price,
		i.order_ite_img,
		i.order_ite_name,
		i.order_ite_sku,
		p.order_pay_id,
		p.order_pay_code,
		p.order_pay_remark,
		fu.found_id,
		fu.head_pic,
		fu.found_join,
		fu.need,
		fl.follow_id,
		b.branch_name,
		b.branch_logo
		from yw_order o 
		left join yw_order_item i on o.order_sn = i.order_sn
		left join yw_order_payment p on o.order_sn = p.order_sn
       	left join yw_team_found fu on o.order_sn = fu.order_id
		left join yw_team_follow fl on o.order_sn = fl.order_id
		left join yw_system_usercenter.yw_branches b on o.branch_id = b.id
        <choose>
         	 <when test="begin == 0 || begin > 0">
         	    inner join (select order_id from yw_order <include refid="wherePageSql" /> order by order_id desc limit #{begin},#{end}) b on o.order_id = b.order_id
         	 </when>
	         <otherwise>
	            <include refid="whereMapSql" />
	         </otherwise>
        </choose>
		
	</select>
	
	<!-- 根据map参数联合yw_member查询 -->
	<select id="queryUnionListByMap" parameterType="java.util.Map" resultType="com.yunwei.product.common.backend.model.dto.YwOrderDto">
		select
		o.order_id,
		o.order_type,
		o.order_flag,
		o.openid,
		o.share_openid,
		o.order_sn,
		o.order_createtime,
		o.order_updatetime,
		o.order_paytime,
		o.order_sendtime,
		o.order_successtime,
		o.order_status,
		o.couponid,
		o.order_name,
		o.order_tel,
		o.order_address,
		o.order_totalprice,
		o.order_remark,
		o.transport_sn,
		o.order_points,
		o.order_import_status,
		o.order_delivery_method,
		o.branch_id,
		o.order_delivery_fee,
		m.nickname,
		s.nickname as share_nickname
		
		from yw_order o 
		left join yw_member m on o.openid = m.openid
		left join yw_member s on o.share_openid = s.openid
		<include refid="whereMapSql" />
		order by order_id desc
	</select>
	
	<!-- 查询表该表与其他表关联信息-->
	<select id="queryUnionPageListByMap" parameterType="java.util.Map" resultType="com.yunwei.product.common.backend.model.dto.YwOrderDto">
		select
		o.order_id,
		o.order_type,
		o.order_flag,
		o.openid,
		o.share_openid,
		o.order_sn,
		o.order_createtime,
		o.order_updatetime,
		o.order_paytime,
		o.order_sendtime,
		o.order_successtime,
		o.order_status,
		o.couponid,
		o.order_name,
		o.order_tel,
		o.order_address,
		o.order_totalprice,
		o.order_remark,
		o.transport_sn,
		o.order_points,
		o.order_import_status,
		o.order_delivery_method,
		o.branch_id,
		o.order_delivery_fee,
		m.nickname,
		s.nickname as share_nickname
		
		from yw_order o 
		left join yw_member m on o.openid = m.openid
		left join yw_member s on o.share_openid = s.openid
        <choose>
         	 <when test="begin == 0 || begin > 0">
         	    inner join (select order_id from yw_order <include refid="wherePageSql" /> order by order_id desc limit #{begin},#{end}) b on o.order_id = b.order_id
         	 </when>
	         <otherwise>
	            <include refid="whereMapSql" />
	         </otherwise>
        </choose>
        <!--
		<where>
			<if test="order_sn != null and order_sn != '' ">
	          and o.order_sn = #{order_sn}
	        </if>
	        <if test="order_remark != null and order_remark != '' ">
	          and o.order_remark like CONCAT(CONCAT('%',#{order_remark}),'%')
	        </if>
	        <if test="nickname != null and nickname != '' ">
	          and o.nickname like CONCAT(CONCAT('%',#{nickname}),'%')
	        </if>
	        <if test="begin_datetime != null and begin_datetime != '' ">
	          and date_format(o.order_createtime,'%Y-%m-%d') &gt;= #{begin_datetime}
	        </if>
	        <if test="end_datetime != null and end_datetime != '' ">
	          and date_format(o.order_createtime,'%Y-%m-%d') &lt;= #{end_datetime}
	        </if>
	        <if test="order_status != null and order_status != '' ">
	          and o.order_status = #{order_status}
	        </if>
	        <if test="branch_id != null and branch_id != '' ">
	          and o.branch_id = #{branch_id}
	        </if>
	        and o.order_status != '9'
		</where>-->
	</select>
	
	<!-- 查询分页信息 -->
	<select id="queryListPage" parameterType="java.util.Map" resultType="com.yunwei.product.common.model.YwOrder">
		select 
		o.order_id,
		o.order_type,
		o.order_flag,
		o.openid,
		o.share_openid,
		o.order_sn,
		o.order_createtime,
		o.order_updatetime,
		o.order_paytime,
		o.order_sendtime,
		o.order_successtime,
		o.order_status,
		o.couponid,
		o.order_name,
		o.order_tel,
		o.order_address,
		o.order_totalprice,
		o.order_remark,
		o.transport_sn,
		o.order_points,
		o.order_import_status,
		o.order_delivery_method,
		o.branch_id,
		o.order_delivery_fee 
        from yw_order inner join (select order_id from yw_order <include refid="wherePageSql" /> order by order_id desc limit #{begin},#{end}) b on o.order_id = b.order_id
	</select>
	
	<!-- 查询总条数 -->
	<select id="queryTotals" parameterType="java.util.Map" resultType="int">
		select count(1) from yw_order
		<where>
			<if test="order_sn != null and order_sn != '' ">
	          and order_sn = #{order_sn}
	        </if>
	        <if test="order_status != null and order_status != '' ">
	          and order_status = #{order_status}
	        </if>
	        <if test="branch_id != null and branch_id != '' ">
	          and branch_id = #{branch_id}
	        </if>
	        <if test="order_remark != null and order_remark != '' ">
	          and order_remark like CONCAT(CONCAT('%',#{order_remark}),'%')
	        </if>
	        <if test="nickname != null and nickname != '' ">
	          and nickname like CONCAT(CONCAT('%',#{nickname}),'%')
	        </if>
	        <if test="begin_datetime != null and begin_datetime != '' ">
	          and date_format(order_createtime,'%Y-%m-%d') &gt;= #{begin_datetime}
	        </if>
	        <if test="end_datetime != null and end_datetime != '' ">
	          and date_format(order_createtime,'%Y-%m-%d') &lt;= #{end_datetime}
	        </if>
	        and order_status != '9'
		</where>
	</select>
	
	<update id="update" parameterType="java.util.Map">
	    update yw_order
	     <trim prefix="set" suffixOverrides=",">
	      <if test="order_type != null and order_type != '' ">
	           order_type = #{order_type},
	      </if>
	      <if test="order_flag != null and order_flag != '' ">
	           order_flag = #{order_flag},
	      </if>
	      <if test="share_openid != null and share_openid != '' ">
	           share_openid = #{share_openid},
	      </if>
	      <if test="order_createtime != null and order_createtime != '' ">
	           order_createtime = #{order_createtime},
	      </if>
	      <if test="order_updatetime != null and order_updatetime != '' ">
	           order_updatetime = #{order_updatetime},
	      </if>
	      <if test="order_paytime != null and order_paytime != '' ">
	           order_paytime = #{order_paytime},
	      </if>
	      <if test="order_sendtime != null and order_sendtime != '' ">
	           order_sendtime = #{order_sendtime},
	      </if>
	      <if test="order_successtime != null and order_successtime != '' ">
	           order_successtime = #{order_successtime},
	      </if>
	      <if test="order_status != null and order_status != '' ">
	           order_status = #{order_status},
	      </if>
	      <if test="couponid != null and couponid != '' ">
	           couponid = #{couponid},
	      </if>
	      <if test="order_name != null and order_name != '' ">
	           order_name = #{order_name},
	      </if>
	      <if test="order_tel != null and order_tel != '' ">
	           order_tel = #{order_tel},
	      </if>
	      <if test="order_address != null and order_address != '' ">
	           order_address = #{order_address},
	      </if>
	      <if test="order_totalprice != null and order_totalprice != '' ">
	           order_totalprice = #{order_totalprice},
	      </if>
	      <if test="order_remark != null and order_remark != '' ">
	           order_remark = #{order_remark},
	      </if>
	      <if test="transport_sn != null and transport_sn != '' ">
	           transport_sn = #{transport_sn},
	      </if>
	      <if test="order_points != null and order_points != '' ">
	           order_points = #{order_points},
	      </if>
	      <if test="order_import_status != null and order_import_status != '' ">
	           order_import_status = #{order_import_status},
	      </if>
	      <if test="order_delivery_method != null and order_delivery_method != '' ">
	           order_delivery_method = #{order_delivery_method},
	      </if>
	      <if test="branch_id != null and branch_id != '' ">
	           branch_id = #{branch_id},
	      </if>
	      <if test="order_delivery_fee != null and order_delivery_fee != '' ">
	           order_delivery_fee = #{order_delivery_fee},
	      </if>
	    </trim>
	    <where>
	    	<if test="order_sn != null and order_sn != '' ">
	    		and order_sn = #{order_sn}
	    	</if>
	    </where>
	</update>
	
	<delete id="delete" parameterType="java.util.Map">
	    delete from yw_order 
	    <include refid="whereSql"/>
	</delete>
	
	<delete id="deleteBatch" parameterType="java.util.Map">
	   delete from yw_order
	   <include refid="whereBatchSql"/>
	</delete>
	
	<!-- 调用存储过程(查询已支付金额的交易金额) -->
	<select id="getPrice" statementType="CALLABLE" parameterType="java.lang.String" resultType="com.yunwei.product.common.model.OrderPriceProcedure">
        {
        	call order_price_statistics_pro (
			           #{branch_id,mode=IN,jdbcType=VARCHAR}
        	)
        }
        
        <!-- 带参数的调用方法
        {
        	call pro (
        		#{id,mode=IN,jdbcType=INTEGER},
        		#{name,mode=IN,jdbcType=INTEGER},
        		
        	)
        }
         -->
    </select>
    
    <!-- 调用存储过程(查询已支付金额的订单数) -->
	<select id="getCount" statementType="CALLABLE" parameterType="java.lang.String" resultType="com.yunwei.product.common.model.OrderCountProcedure">
        {
        	call order_count_statistics_pro (
			           #{branch_id,mode=IN,jdbcType=VARCHAR}
        		
        	)
        }
        
        <!-- 带参数的调用方法
        {
        	call pro (
        		#{id,mode=IN,jdbcType=INTEGER},
        		#{name,mode=IN,jdbcType=INTEGER},
        		
        	)
        }
         -->
    </select>
    
    <!-- 导出excel表单数据关联查询 -->
	<select id="importExcelByOrder" parameterType="java.util.Map" resultMap="resultMap">
		select
		o.order_type,
		o.order_sn,
		o.order_createtime,
		o.order_status,
		o.order_name,
		o.order_tel,
		o.order_address,
		o.order_remark,
		o.transport_sn,
		i.order_ite_count,
		i.order_ite_price,
		i.order_ite_name,
		i.order_ite_sku
		from yw_order o 
		left join yw_order_item i on o.order_sn = i.order_sn
        <include refid="whereMapSql" />
	</select>
	
	<!-- 批量更新 -->
	<update id="updateBatch">
	     update yw_order
	     <trim prefix="set" suffixOverrides=",">
	        <foreach collection="fields" item="field" separator="end," close="end">
	          ${field} = CASE order_sn
	          <foreach collection="lists" item="item">
	              when #{item.order_sn} then #{item.${field}}
	          </foreach>
	        </foreach>
	     </trim>
	     <where>
	         and order_sn in
	        <foreach collection="lists" item="item" separator="," open="(" close=")">
	            #{item.order_sn}
	        </foreach>
	     </where>
	</update>

</mapper>