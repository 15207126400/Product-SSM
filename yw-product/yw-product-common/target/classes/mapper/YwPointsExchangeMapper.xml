<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yunwei.product.common.dao.YwPointsExchangeDao">

    <sql id="sql">
         exchange_id,
         user_id,
         exchange_type,
         order_sn,
         points,
         price,
         product_id,
         create_datetime,
         status
    </sql>
    
    <sql id="insertSql">
         user_id,
         exchange_type,
         order_sn,
         points,
         price,
         product_id,
         create_datetime,
         status
    </sql>
    <!-- 当前表条件 -->
    <sql id = "whereSql">
	   <where>
            <if test="exchange_id != null and exchange_id != '' ">
	          and exchange_id = #{exchange_id}
	        </if>
            <if test="user_id != null and user_id != '' ">
	          and user_id = #{user_id}
	        </if>
            <if test="exchange_type != null and exchange_type != '' ">
	          and exchange_type = #{exchange_type}
	        </if>
	        <if test="order_sn != null and order_sn != '' ">
	          and order_sn = #{order_sn}
	        </if>
            <if test="points != null and points != '' ">
	          and points = #{points}
	        </if>
            <if test="price != null and price != '' ">
	          and price = #{price}
	        </if>
            <if test="product_id != null and product_id != '' ">
	          and product_id = #{product_id}
	        </if>
            <if test="create_datetime != null and create_datetime != '' ">
	          and create_datetime = #{create_datetime}
	        </if>
            <if test="status != null and status != '' ">
	          and status = #{status}
	        </if>
	    </where> 
    </sql>
    
    <!-- 当前表(或不存在当前表)条件(Map参数) -->
    <sql id = "whereMapSql">
	   <where>
            <if test="exchange_id != null and exchange_id != '' ">
	          and exchange_id = #{exchange_id}
	        </if>
            <if test="user_id != null and user_id != '' ">
	          and user_id = #{user_id}
	        </if>
            <if test="exchange_type != null and exchange_type != '' ">
	          and exchange_type = #{exchange_type}
	        </if>
	        <if test="order_sn != null and order_sn != '' ">
	          and order_sn = #{order_sn}
	        </if>
            <if test="points != null and points != '' ">
	          and points = #{points}
	        </if>
            <if test="price != null and price != '' ">
	          and price = #{price}
	        </if>
            <if test="product_id != null and product_id != '' ">
	          and product_id = #{product_id}
	        </if>
            <if test="create_datetime != null and create_datetime != '' ">
	          and create_datetime = #{create_datetime}
	        </if>
            <if test="status != null and status != '' ">
	          and status = #{status}
	        </if>
	    </where> 
    </sql>
    
    <!-- 当前表批量删除条件 -->
    <sql id="whereBatchSql">
		<where>
			<if test="exchange_id != null and exchange_id != '' ">
				and exchange_id in
				<foreach collection="exchange_id" item="id" separator="," open="("
					close=")">
					#{id}
				</foreach>
			</if>
		</where>
	</sql>

	<!-- 当前表添加-->
	<insert id="insert" parameterType="com.yunwei.product.common.model.YwPointsExchange">
		insert into yw_points_exchange(<include refid="insertSql"/>) 
		values(
	             #{user_id},
	             #{exchange_type},
	             #{order_sn},
	             #{points},
	             #{price},
	             #{product_id},
	             #{create_datetime},
	             #{status}
		     )
	</insert>
	
	<!-- 查询表该表与其他表关联信息-->
	<select id="queryUnionMemberList" parameterType="java.util.Map"
		resultType="com.yunwei.product.common.backend.model.dto.YwPointsExchangeDto">
		select
			 e.exchange_id,
	         e.user_id,
	         e.exchange_type,
	         e.order_sn,
	         e.points,
	         e.price,
	         e.product_id,
	         e.create_datetime,
	         e.status,
	         m.openid,
	         m.nickname
			
		from yw_points_exchange e
			left join yw_member m on e.user_id = m.openid
			<where>
				<if test="exchange_id != null and exchange_id != '' ">
		          and exchange_id = #{exchange_id}
		        </if>
		    </where> 
			order by create_datetime desc
			limit #{begin},#{end}
	</select>
	
	<!-- 当前表查询 -->
	<select id="queryList" parameterType="java.util.Map" resultType="com.yunwei.product.common.model.YwPointsExchange">
		select <include refid="sql"/> from yw_points_exchange
		<include refid="whereSql"/>
	</select>
	
	<!-- 查询兑换表与订单项表关联信息-->
	<select id="queryUnionByOrderitems" parameterType="java.util.Map" resultType="com.yunwei.product.common.infobase.model.dto.YwPointsExchangeByOrderItemsDto">
		select
			 e.exchange_id,
	         e.user_id,
	         e.exchange_type,
	         e.order_sn,
	         e.points,
	         e.price,
	         e.product_id,
	         e.create_datetime,
	         e.status,
	         o.order_ite_count,
	         o.order_ite_price,
	         o.order_ite_img,
	         o.order_ite_name,
	         o.order_ite_sku
		from yw_points_exchange e 
			left join yw_order_item o on e.order_sn = o.order_sn
		<where>
			<if test="exchange_id != null and exchange_id != '' ">
		       and exchange_id = #{exchange_id}
		    </if>
		</where>
	</select>
	
	<!-- 查询兑换表与优惠券关联信息-->
	<select id="queryUnionByCoupon" parameterType="java.util.Map" resultType="com.yunwei.product.common.infobase.model.dto.YwPointsExchangeByCouponDto">
		select
			 e.exchange_id,
	         e.user_id,
	         e.exchange_type,
	         e.order_sn,
	         e.points,
	         e.price,
	         e.product_id,
	         e.create_datetime,
	         e.status,
	         c.coupon_name,
	         c.coupon_scene_type,
	         c.coupon_function_type,
	         c.coupon_use_scope_type,
	         c.coupon_use_scope,
	         c.coupon_price
	         
		from yw_points_exchange e 
			left join yw_coupon c on e.product_id = c.id
		<where>
			<if test="exchange_id != null and exchange_id != '' ">
		       and exchange_id = #{exchange_id}
		    </if>
		</where>
	</select>
	
	<!-- 动态排序列表查询 -->
	<select id="orderByQueryList" parameterType="java.util.Map" resultType="com.yunwei.product.common.model.YwPointsExchange">
		select <include refid="sql"/> from yw_points_exchange
		<include refid="whereSql"/>
		ORDER BY
		<choose>
			<when test="columnName != null">
				${columnName}
			</when>
			<otherwise>
				create_datetime
			</otherwise>
		</choose>
		<choose>
			<when test="sort != null">
				${sort}
			</when>
			<otherwise>
				desc
			</otherwise>
		</choose>
		<if test="begin == 0 || begin > 0">
             limit #{begin},#{end}
        </if>
	</select>
	
	<!-- 当前表分页查询(Map参数) -->
	<select id="queryListPage" parameterType="java.util.Map" resultType="com.yunwei.product.common.model.YwPointsExchange">
		select <include refid="sql"/> from yw_points_exchange
		<include refid="whereSql"/>
		order by exchange_id desc
		limit #{begin},#{end}
	</select>
	
	<!-- 当前表查询总条数 -->
	<select id="queryTotals" parameterType="java.util.Map" resultType="int">
		select count(1) from yw_points_exchange
		<include refid="whereSql"/>
	</select>
	
	<!-- 当前表更新 -->
	<update id="update" parameterType="java.util.Map">
	    update yw_points_exchange
	     <trim prefix="set" suffixOverrides=",">
            <if test="user_id != null and user_id != '' ">
	           user_id = #{user_id},
	        </if>
            <if test="exchange_type != null and exchange_type != '' ">
	           exchange_type = #{exchange_type},
	        </if>
	        <if test="order_sn != null and order_sn != '' ">
	           order_sn = #{order_sn},
	        </if>
            <if test="points != null and points != '' ">
	           points = #{points},
	        </if>
            <if test="price != null and price != '' ">
	           price = #{price},
	        </if>
            <if test="product_id != null and product_id != '' ">
	           product_id = #{product_id},
	        </if>
            <if test="create_datetime != null and create_datetime != '' ">
	           create_datetime = #{create_datetime},
	        </if>
            <if test="status != null and status != '' ">
	           status = #{status},
	        </if>
	    </trim>
	    <where>
             <if test="exchange_id != null and exchange_id != '' ">
	           and exchange_id = #{exchange_id}
	         </if>
	    </where>
	</update>
	
	<!-- 当前表删除 -->
	<delete id="delete" parameterType="java.util.Map">
	    delete from yw_Points_exchange 
	    <where>
            <if test="exchange_id != null and exchange_id != '' ">
	           and exchange_id = #{exchange_id}
	        </if>
	    </where>
	</delete>
	
	<!-- 当前批量删除 -->
	<delete id="deleteBatch" parameterType="java.util.Map">
	   delete from yw_points_exchange
	   <include refid="whereBatchSql"/>
	</delete>
	
</mapper>